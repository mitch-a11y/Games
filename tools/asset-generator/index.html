<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HANSE Asset Generator</title>
<style>
  :root {
    --bg: #0e0c09;
    --surface: #1a1610;
    --surface2: #241e14;
    --border: #3d3020;
    --accent: #c8922a;
    --accent2: #e6b84a;
    --text: #e8dcc8;
    --muted: #8a7a5c;
    --success: #4a9e6a;
    --error: #c84a4a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Segoe UI', system-ui, sans-serif;
    min-height: 100vh;
    padding: 20px 24px 40px;
  }

  header {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 24px;
    padding-bottom: 18px;
    border-bottom: 1px solid var(--border);
  }

  .header-left { display: flex; align-items: center; gap: 14px; flex: 1; }

  header h1 {
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    color: var(--accent2);
  }

  .badge {
    font-size: 0.78rem;
    color: var(--muted);
    background: var(--surface2);
    padding: 3px 10px;
    border-radius: 20px;
    border: 1px solid var(--border);
  }

  .anchor { font-size: 1.4rem; }

  .header-hint {
    font-size: 0.75rem;
    color: var(--muted);
  }

  .layout {
    display: grid;
    grid-template-columns: 340px 1fr;
    gap: 20px;
    align-items: start;
  }

  .sidebar { display: flex; flex-direction: column; gap: 14px; }

  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px;
  }

  .panel-title {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
    margin-bottom: 14px;
  }

  /* API KEY */
  .api-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .api-row input {
    flex: 1;
    font-family: monospace;
    font-size: 0.78rem;
  }

  .status-dot {
    width: 9px;
    height: 9px;
    border-radius: 50%;
    background: var(--border);
    flex-shrink: 0;
    transition: background 0.3s;
  }

  .status-dot.ok { background: var(--success); box-shadow: 0 0 6px var(--success); }
  .status-dot.err { background: var(--error); }

  /* CATEGORY GRID */
  .category-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 7px;
  }

  .cat-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 9px 6px;
    cursor: pointer;
    text-align: center;
    transition: all 0.15s;
    color: var(--text);
    font-size: 0.8rem;
    font-family: inherit;
  }

  .cat-btn:hover { border-color: var(--accent); background: #2a2015; }
  .cat-btn.active { border-color: var(--accent2); background: #2e2210; color: var(--accent2); }
  .cat-btn .icon { font-size: 1.25rem; display: block; margin-bottom: 3px; }

  /* FORM */
  .field { margin-top: 13px; }
  .field:first-child { margin-top: 0; }

  .field label {
    display: block;
    font-size: 0.75rem;
    color: var(--muted);
    margin-bottom: 5px;
  }

  input[type="text"], input[type="password"], textarea, select {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 9px 11px;
    color: var(--text);
    font-size: 0.86rem;
    font-family: inherit;
    outline: none;
    transition: border-color 0.15s;
  }

  input:focus, textarea:focus, select:focus { border-color: var(--accent); }

  textarea { resize: vertical; min-height: 80px; line-height: 1.5; }

  select option { background: #1a1610; }

  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  /* STYLE CHIPS */
  .chips {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 6px;
  }

  .chip {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 3px 9px;
    font-size: 0.73rem;
    cursor: pointer;
    transition: all 0.15s;
    color: var(--muted);
    user-select: none;
  }

  .chip:hover { border-color: var(--accent); color: var(--text); }
  .chip.active { border-color: var(--accent2); background: #2e2210; color: var(--accent2); }

  /* PROGRESS */
  .progress-wrap { margin-top: 13px; display: none; }
  .progress-wrap.show { display: block; }

  .progress-label {
    font-size: 0.72rem;
    color: var(--muted);
    margin-bottom: 5px;
    display: flex;
    justify-content: space-between;
  }

  .progress-bar {
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 2px;
    transition: width 0.4s;
    width: 0%;
  }

  /* GENERATE BUTTON */
  .gen-btn {
    width: 100%;
    margin-top: 14px;
    padding: 13px;
    background: linear-gradient(135deg, #b07820, var(--accent2));
    border: none;
    border-radius: 10px;
    color: #0e0c09;
    font-size: 0.95rem;
    font-weight: 700;
    cursor: pointer;
    letter-spacing: 0.04em;
    transition: all 0.15s;
    font-family: inherit;
  }

  .gen-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(200,146,42,0.35); }
  .gen-btn:active { transform: translateY(0); }
  .gen-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

  /* QUICK PRESETS */
  .preset-list {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .preset-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 7px 11px;
    font-size: 0.78rem;
    color: var(--muted);
    cursor: pointer;
    text-align: left;
    width: 100%;
    font-family: inherit;
    transition: all 0.15s;
  }

  .preset-item:hover { border-color: var(--accent); color: var(--text); }

  /* MAIN PANEL */
  .main-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px; }

  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .results-title {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .count-badge {
    background: var(--accent);
    color: #0e0c09;
    font-size: 0.62rem;
    font-weight: 700;
    padding: 2px 7px;
    border-radius: 10px;
  }

  .batch-btns { display: flex; gap: 7px; }

  .sm-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 5px 11px;
    font-size: 0.73rem;
    color: var(--muted);
    cursor: pointer;
    font-family: inherit;
    transition: all 0.15s;
  }

  .sm-btn:hover { border-color: var(--accent); color: var(--text); }

  /* GALLERY */
  .gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
    gap: 14px;
  }

  .img-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    transition: border-color 0.15s, transform 0.15s;
    cursor: pointer;
    animation: fadeUp 0.3s ease;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .img-card:hover { border-color: var(--accent); transform: translateY(-2px); }

  .img-card img {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    display: block;
  }

  .img-meta {
    padding: 9px 11px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .img-num { font-size: 0.73rem; color: var(--muted); }

  .img-actions { display: flex; gap: 5px; }

  .icon-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 4px 7px;
    cursor: pointer;
    font-size: 0.82rem;
    transition: all 0.15s;
    color: var(--text);
    font-family: inherit;
  }

  .icon-btn:hover { border-color: var(--accent); background: #2a2015; }

  /* LOADING CARD */
  .loading-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 10px;
  }

  .spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent2);
    border-radius: 50%;
    animation: spin 0.75s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text { font-size: 0.74rem; color: var(--muted); }

  /* EMPTY */
  .empty {
    grid-column: 1 / -1;
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }

  .empty .big { font-size: 3rem; margin-bottom: 12px; }
  .empty p { font-size: 0.88rem; line-height: 1.6; }
  .empty strong { color: var(--accent2); }

  /* LIGHTBOX */
  .lightbox {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.88);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }

  .lightbox.show { opacity: 1; pointer-events: all; }

  .lightbox img {
    max-width: 90vw;
    max-height: 90vh;
    border-radius: 10px;
    border: 1px solid var(--border);
    box-shadow: 0 20px 80px rgba(0,0,0,0.8);
  }

  .lightbox-close {
    position: fixed;
    top: 20px;
    right: 24px;
    font-size: 1.8rem;
    color: var(--muted);
    cursor: pointer;
    line-height: 1;
    transition: color 0.15s;
  }

  .lightbox-close:hover { color: var(--text); }

  /* NOTIFICATION */
  .notif {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 11px 17px;
    font-size: 0.84rem;
    max-width: 300px;
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.25s;
    z-index: 999;
  }

  .notif.show { transform: translateY(0); opacity: 1; }
  .notif.ok { border-color: var(--success); color: var(--text); }
  .notif.err { border-color: var(--error); color: var(--error); }

  /* COLLAPSIBLE */
  .collapsible-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    user-select: none;
  }

  .collapsible-arrow {
    font-size: 0.7rem;
    color: var(--muted);
    transition: transform 0.2s;
  }

  .collapsible-body { overflow: hidden; }
  .collapsible-body.collapsed { display: none; }

  @media (max-width: 860px) {
    .layout { grid-template-columns: 1fr; }
    body { padding: 14px; }
  }
</style>
</head>
<body>

<header>
  <div class="header-left">
    <span class="anchor">‚öì</span>
    <h1>HANSE Asset Generator</h1>
    <span class="badge">Leonardo AI</span>
  </div>
  <span class="header-hint">Ctrl+Enter = Generieren</span>
</header>

<div class="layout">
  <!-- LEFT SIDEBAR -->
  <div class="sidebar">

    <!-- API KEY -->
    <div class="panel">
      <div class="panel-title">API Key</div>
      <div class="api-row">
        <input type="password" id="apiKey" placeholder="Leonardo API Key..." autocomplete="off">
        <div class="status-dot" id="apiDot" title="API Key Status"></div>
      </div>
    </div>

    <!-- KATEGORIE + EINSTELLUNGEN -->
    <div class="panel">
      <div class="panel-title">Asset-Kategorie</div>
      <div class="category-grid" id="catGrid">
        <button class="cat-btn active" data-cat="ships"><span class="icon">‚õµ</span>Schiffe</button>
        <button class="cat-btn" data-cat="cities"><span class="icon">üè∞</span>St√§dte</button>
        <button class="cat-btn" data-cat="goods"><span class="icon">üì¶</span>Waren</button>
        <button class="cat-btn" data-cat="characters"><span class="icon">üßë‚Äç‚úàÔ∏è</span>Charaktere</button>
        <button class="cat-btn" data-cat="ui"><span class="icon">üé®</span>UI-Elemente</button>
        <button class="cat-btn" data-cat="backgrounds"><span class="icon">üåä</span>Hintergr√ºnde</button>
        <button class="cat-btn" data-cat="icons"><span class="icon">‚ö°</span>Icons</button>
        <button class="cat-btn" data-cat="custom"><span class="icon">‚úèÔ∏è</span>Eigener</button>
      </div>

      <div class="field">
        <label>Prompt <small style="color:var(--muted);font-size:0.7rem">(kombiniert mit HANSE-Stil)</small></label>
        <textarea id="prompt" placeholder="z.B. Hansekogge, Seitenansicht, auf ruhiger See..."></textarea>
      </div>

      <div class="field">
        <label>Stil-Modifikatoren</label>
        <div class="chips" id="chips">
          <span class="chip active" data-tag="medieval hanseatic style">Hanseatisch</span>
          <span class="chip active" data-tag="detailed illustration">Detailliert</span>
          <span class="chip" data-tag="transparent background">Transparent</span>
          <span class="chip" data-tag="pixel art">Pixel Art</span>
          <span class="chip" data-tag="oil painting">√ñlgem√§lde</span>
          <span class="chip" data-tag="flat design icon">Flat Icon</span>
          <span class="chip" data-tag="isometric view">Isometrisch</span>
          <span class="chip" data-tag="top down view">Top-Down</span>
          <span class="chip" data-tag="sepia tone">Sepia</span>
          <span class="chip" data-tag="game asset sprite sheet">Sprite Sheet</span>
        </div>
      </div>

      <div class="field row">
        <div>
          <label>Format</label>
          <select id="aspect">
            <option value="512x512">512√ó512 (Quadrat)</option>
            <option value="768x512">768√ó512 (Quer)</option>
            <option value="512x768">512√ó768 (Hoch)</option>
            <option value="1024x1024">1024√ó1024 (HD)</option>
            <option value="1024x768">1024√ó768 (HD Quer)</option>
          </select>
        </div>
        <div>
          <label>Anzahl</label>
          <select id="count">
            <option value="1">1 Bild</option>
            <option value="2">2 Bilder</option>
            <option value="4" selected>4 Bilder</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label>Modell</label>
        <select id="model">
          <option value="b24e16ff-06e3-43eb-8d33-4416c2d75876">Leonardo Diffusion XL</option>
          <option value="6bef9f1b-29cb-40c7-b9df-32b51c1f67d3">Leonardo Creative</option>
          <option value="aa77f04e-3eec-4034-9c07-d0f619684628">Leonardo Kino XL</option>
          <option value="1e60896f-3c26-4296-8ecc-53e2afecc132">Leonardo Diffusion</option>
          <option value="5c232a9e-9061-4777-980a-ddc8e65647c6">DreamShaper v7</option>
          <option value="e316348f-7773-490e-adcd-46757c738eb9">Absolute Reality v1.6</option>
        </select>
      </div>

      <!-- ADVANCED (collapsible) -->
      <div class="field">
        <div class="collapsible-header" onclick="toggleAdvanced()">
          <label style="cursor:pointer;margin:0">Negativer Prompt</label>
          <span class="collapsible-arrow" id="advArrow">‚ñº</span>
        </div>
        <div class="collapsible-body collapsed" id="advBody">
          <textarea id="negPrompt" style="margin-top:6px;min-height:60px;font-size:0.78rem" placeholder="Was soll NICHT im Bild sein...">modern, contemporary, futuristic, low quality, blurry, watermark, signature, text, logo</textarea>
        </div>
      </div>

      <div class="progress-wrap" id="progressWrap">
        <div class="progress-label">
          <span id="progressLabel">Generiere...</span>
          <span id="progressPct">0%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>

      <button class="gen-btn" id="genBtn" onclick="generate()">‚ö° Generieren</button>
    </div>

    <!-- QUICK PRESETS -->
    <div class="panel">
      <div class="panel-title">Schnell-Presets</div>
      <div class="preset-list">
        <button class="preset-item" onclick="loadPreset('cog')">‚õµ Hansekogge (Seitenansicht)</button>
        <button class="preset-item" onclick="loadPreset('caravel')">üö¢ Karavelle (transparent)</button>
        <button class="preset-item" onclick="loadPreset('lubeck')">üè∞ L√ºbeck Stadtansicht</button>
        <button class="preset-item" onclick="loadPreset('spices')">üåø Gew√ºrze &amp; Waren Icons</button>
        <button class="preset-item" onclick="loadPreset('merchant')">üßî Hansekaufmann Portrait</button>
        <button class="preset-item" onclick="loadPreset('sea')">üåä Ostsee Hintergrund</button>
        <button class="preset-item" onclick="loadPreset('map')">üó∫Ô∏è Mittelalterliche Seekarte</button>
        <button class="preset-item" onclick="loadPreset('harbor')">‚öì Hafenszene</button>
      </div>
    </div>

  </div>

  <!-- RIGHT: GALLERY -->
  <div class="main-panel">
    <div class="results-header">
      <div class="results-title">
        Generierte Assets
        <span class="count-badge" id="countBadge">0</span>
      </div>
      <div class="batch-btns">
        <button class="sm-btn" onclick="downloadAll()">‚¨á Alle laden</button>
        <button class="sm-btn" onclick="clearGallery()">üóë Leeren</button>
      </div>
    </div>
    <div class="gallery" id="gallery">
      <div class="empty">
        <div class="big">‚öì</div>
        <p>Kategorie w√§hlen und auf <strong>Generieren</strong> klicken.<br>
        <span style="font-size:0.8rem;opacity:0.7">Tipp: Schnell-Presets liefern optimierte Prompts.</span></p>
      </div>
    </div>
  </div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <span class="lightbox-close">‚úï</span>
  <img id="lightboxImg" src="" alt="Asset Vorschau">
</div>

<div class="notif" id="notif"></div>

<script>
// ‚îÄ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STYLE_BASE = "medieval hanseatic era, 15th century Baltic trade, high quality game art, consistent art style";

const CAT_PROMPTS = {
  ships: "hansekogge sailing ship, detailed wooden medieval vessel, Baltic Sea, side view",
  cities: "medieval hanseatic city, half-timbered houses, market square, church tower, cobblestone streets",
  goods: "medieval trade goods, cloth bolts, barrels, crates, salt, fish, amber, arranged neatly",
  characters: "medieval merchant, hanseatic trader, period clothing, portrait style",
  ui: "medieval UI element, parchment texture, wooden frame, decorative border, game interface",
  backgrounds: "Baltic Sea landscape, medieval harbor, North Sea storm, calm waters, medieval coastline",
  icons: "medieval item icon, single object, clean background, game inventory style",
  custom: ""
};

const PRESETS = {
  cog:      { prompt: "hansekogge cog sailing ship, detailed wooden hull, single mast, side profile view, Baltic Sea background, 15th century", tags: ['medieval hanseatic style', 'detailed illustration'], cat: 'ships' },
  caravel:  { prompt: "medieval caravel sailing ship, detailed rigging, three masts, isolated on white background", tags: ['medieval hanseatic style', 'detailed illustration', 'transparent background'], cat: 'ships' },
  lubeck:   { prompt: "Luebeck medieval city panorama, Holstentor gate, church spires, harbor with ships, golden hour light, panoramic view", tags: ['medieval hanseatic style', 'oil painting'], cat: 'cities' },
  spices:   { prompt: "set of medieval trade goods icons, spices pepper saffron cinnamon, cloth amber salt fish, individual items on dark background", tags: ['medieval hanseatic style', 'flat design icon'], cat: 'goods' },
  merchant: { prompt: "hanseatic merchant portrait, wealthy 15th century trader, fur-trimmed coat, confident expression, studio portrait", tags: ['medieval hanseatic style', 'detailed illustration'], cat: 'characters' },
  sea:      { prompt: "Baltic Sea panorama background, calm water, dramatic cloudy sky, distant coastline, atmospheric, wide angle", tags: ['medieval hanseatic style', 'detailed illustration'], cat: 'backgrounds' },
  map:      { prompt: "antique medieval nautical map, Baltic Sea, hand drawn coastlines, compass rose, sea monsters, aged parchment", tags: ['sepia tone', 'detailed illustration'], cat: 'backgrounds' },
  harbor:   { prompt: "medieval harbor scene, wooden docks, ships loading cargo, merchants and sailors, busy port atmosphere", tags: ['medieval hanseatic style', 'detailed illustration'], cat: 'cities' }
};

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentCat = 'ships';
let activeTags = new Set(['medieval hanseatic style', 'detailed illustration']);
let totalGenerated = 0;
let advOpen = false;

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function init() {
  // Load saved API key
  const saved = localStorage.getItem('hanse_api_key');
  if (saved) {
    document.getElementById('apiKey').value = saved;
    document.getElementById('apiDot').className = 'status-dot ok';
  }

  // Category buttons
  document.getElementById('catGrid').addEventListener('click', e => {
    const btn = e.target.closest('.cat-btn');
    if (!btn) return;
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentCat = btn.dataset.cat;
    const p = CAT_PROMPTS[currentCat];
    const promptEl = document.getElementById('prompt');
    promptEl.placeholder = p || 'Eigener Prompt...';
  });

  // Style chips
  document.getElementById('chips').addEventListener('click', e => {
    const chip = e.target.closest('.chip');
    if (!chip) return;
    const tag = chip.dataset.tag;
    if (activeTags.has(tag)) { activeTags.delete(tag); chip.classList.remove('active'); }
    else { activeTags.add(tag); chip.classList.add('active'); }
  });

  // API key persistence + dot
  document.getElementById('apiKey').addEventListener('input', e => {
    const val = e.target.value.trim();
    localStorage.setItem('hanse_api_key', val);
    document.getElementById('apiDot').className = 'status-dot ' + (val ? 'ok' : 'err');
  });

  // Keyboard shortcut
  document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      if (!document.getElementById('genBtn').disabled) generate();
    }
    if (e.key === 'Escape') closeLightbox();
  });
})();

// ‚îÄ‚îÄ‚îÄ ADVANCED TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleAdvanced() {
  advOpen = !advOpen;
  document.getElementById('advBody').classList.toggle('collapsed', !advOpen);
  document.getElementById('advArrow').style.transform = advOpen ? 'rotate(180deg)' : '';
}

// ‚îÄ‚îÄ‚îÄ PRESET LOADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadPreset(key) {
  const p = PRESETS[key];
  if (!p) return;
  document.getElementById('prompt').value = p.prompt;
  activeTags = new Set(p.tags);
  document.querySelectorAll('.chip').forEach(c => {
    c.classList.toggle('active', activeTags.has(c.dataset.tag));
  });
  document.querySelectorAll('.cat-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.cat === p.cat);
  });
  currentCat = p.cat;
  showNotif(`Preset geladen: ${key}`, 'ok');
}

// ‚îÄ‚îÄ‚îÄ BUILD PROMPT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildPrompt(userPrompt) {
  const tagStr = [...activeTags].join(', ');
  const base = userPrompt.trim() || CAT_PROMPTS[currentCat] || 'hanseatic medieval scene';
  return `${base}, ${tagStr}, ${STYLE_BASE}`;
}

// ‚îÄ‚îÄ‚îÄ GENERATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generate() {
  const apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) { showNotif('API Key fehlt!', 'err'); return; }

  const userPrompt = document.getElementById('prompt').value;
  const aspectVal = document.getElementById('aspect').value;
  const [w, h] = aspectVal.split('x').map(Number);
  const count = parseInt(document.getElementById('count').value);
  const model = document.getElementById('model').value;
  const negPrompt = document.getElementById('negPrompt').value.trim();
  const fullPrompt = buildPrompt(userPrompt);

  const btn = document.getElementById('genBtn');
  btn.disabled = true;
  btn.textContent = '‚è≥ Generiere...';
  setProgress(10, 'Starte Generation...');

  // Add loaders to gallery
  const gallery = document.getElementById('gallery');
  gallery.querySelectorAll('.empty').forEach(e => e.remove());
  const loaders = [];
  for (let i = 0; i < count; i++) {
    const card = document.createElement('div');
    card.className = 'loading-card';
    card.innerHTML = '<div class="spinner"></div><div class="loading-text">Generiere...</div>';
    gallery.prepend(card);
    loaders.push(card);
  }

  try {
    // POST to Leonardo
    const res = await fetch('https://cloud.leonardo.ai/api/rest/v1/generations', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        prompt: fullPrompt,
        negative_prompt: negPrompt,
        modelId: model,
        width: w,
        height: h,
        num_images: count,
        public: false,
        promptMagic: false
      })
    });

    if (!res.ok) {
      const errData = await res.json().catch(() => ({}));
      throw new Error(errData.error || errData.message || `HTTP ${res.status}`);
    }

    const data = await res.json();
    const genId = data.sdGenerationJob?.generationId;
    if (!genId) throw new Error('Keine Generation-ID erhalten');

    setProgress(30, 'Warte auf Ergebnisse...');

    // Poll
    let images = [];
    let attempts = 0;
    while (attempts < 35 && images.length === 0) {
      await sleep(2000);
      attempts++;
      setProgress(30 + attempts * 1.8, `Poll ${attempts}/35...`);

      const pollRes = await fetch(`https://cloud.leonardo.ai/api/rest/v1/generations/${genId}`, {
        headers: { 'authorization': `Bearer ${apiKey}` }
      });

      if (!pollRes.ok) continue;
      const pollData = await pollRes.json();
      const gen = pollData.generations_by_pk;

      if (gen?.status === 'COMPLETE') {
        images = gen.generated_images || [];
        break;
      } else if (gen?.status === 'FAILED') {
        throw new Error('Generierung fehlgeschlagen');
      }
    }

    if (images.length === 0) throw new Error('Timeout ‚Äì bitte erneut versuchen');

    setProgress(96, 'Fast fertig...');
    loaders.forEach(l => l.remove());

    images.forEach((img, i) => {
      const filename = `hanse_${currentCat}_${Date.now()}_${i + 1}.png`;
      totalGenerated++;
      addImageCard(gallery, img.url, filename, totalGenerated, fullPrompt);
    });

    document.getElementById('countBadge').textContent = totalGenerated;
    setProgress(100, 'Fertig!');
    setTimeout(() => hideProgress(), 900);
    showNotif(`${images.length} Asset${images.length > 1 ? 's' : ''} generiert ‚úì`, 'ok');

  } catch (err) {
    loaders.forEach(l => l.remove());
    if (gallery.children.length === 0) {
      gallery.innerHTML = `<div class="empty"><div class="big">‚ö†Ô∏è</div><p>${err.message}</p></div>`;
    }
    hideProgress();
    showNotif(`Fehler: ${err.message}`, 'err');
    console.error('[HANSE]', err);
  } finally {
    btn.disabled = false;
    btn.textContent = '‚ö° Generieren';
  }
}

// ‚îÄ‚îÄ‚îÄ IMAGE CARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addImageCard(gallery, url, filename, num, prompt) {
  const card = document.createElement('div');
  card.className = 'img-card';
  card.innerHTML = `
    <img src="${url}" alt="${filename}" loading="lazy" onclick="openLightbox('${url}')">
    <div class="img-meta">
      <span class="img-num">#${num}</span>
      <div class="img-actions">
        <button class="icon-btn" title="Download" onclick="event.stopPropagation();dlImg('${url}','${filename}')">‚¨á</button>
        <button class="icon-btn" title="Prompt kopieren" onclick="event.stopPropagation();copyPrompt(\`${prompt.replace(/`/g, '\\`')}\`)">üìã</button>
      </div>
    </div>
  `;
  gallery.prepend(card);
}

// ‚îÄ‚îÄ‚îÄ LIGHTBOX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openLightbox(url) {
  document.getElementById('lightboxImg').src = url;
  document.getElementById('lightbox').classList.add('show');
}

function closeLightbox() {
  document.getElementById('lightbox').classList.remove('show');
}

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function setProgress(pct, label) {
  document.getElementById('progressWrap').classList.add('show');
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressPct').textContent = Math.round(pct) + '%';
  if (label) document.getElementById('progressLabel').textContent = label;
}

function hideProgress() {
  setTimeout(() => {
    document.getElementById('progressWrap').classList.remove('show');
    document.getElementById('progressFill').style.width = '0%';
  }, 400);
}

async function dlImg(url, filename) {
  try {
    const res = await fetch(url);
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    showNotif(`"${filename}" gespeichert`, 'ok');
  } catch {
    window.open(url, '_blank');
  }
}

function downloadAll() {
  const imgs = document.querySelectorAll('.img-card img');
  if (!imgs.length) { showNotif('Keine Bilder vorhanden', 'err'); return; }
  imgs.forEach((img, i) => {
    setTimeout(() => dlImg(img.src, `hanse_asset_${i + 1}.png`), i * 600);
  });
  showNotif(`${imgs.length} Bilder werden geladen...`, 'ok');
}

function copyPrompt(prompt) {
  navigator.clipboard.writeText(prompt)
    .then(() => showNotif('Prompt kopiert!', 'ok'))
    .catch(() => showNotif('Kopieren fehlgeschlagen', 'err'));
}

function clearGallery() {
  document.getElementById('gallery').innerHTML = `<div class="empty"><div class="big">‚öì</div><p>Kategorie w√§hlen und auf <strong>Generieren</strong> klicken.</p></div>`;
  totalGenerated = 0;
  document.getElementById('countBadge').textContent = '0';
}

function showNotif(msg, type = 'ok') {
  const n = document.getElementById('notif');
  n.textContent = msg;
  n.className = `notif ${type} show`;
  clearTimeout(n._t);
  n._t = setTimeout(() => n.classList.remove('show'), 3200);
}
</script>
</body>
</html>
